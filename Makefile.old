ROOT=.
include $(ROOT)/Config.mk
include $(ROOT)/makearch/$(ARCH)

SUBDIRS = common dynadag incrface pathplot shortspline fdp shortspline voronoi

INCS = -I. \
	-I.. -I../cdt \
	-I$(GRAPHVIZ_INC)

DEFINES = -DHAVE_CONFIG_H

GVIZLIBS = -L$(GRAPHVIZ_LIB) \
       -lcgraph -lpathplan -lcdt

DGLIBS = -Lincrface -lincrface \
	-Ldynadag -ldynadag \
	-Lpathplot -lpathplot \
	-Lfdp -lfdp \
	-Lshortspline -lshortspline \
	-Lvoronoi -lvoronoi \
    -Lcommon -ldynagraph

GGLIBS = -Lcommon -ldynagraph \
       -L$(GRAPHVIZ_LIB) \
       -lcdt -lcgraph

OBJS = IncrCalledBack.o DuplicateStream.o createConfiguration.o

MANS = 

GET_VERSION = `./dynagraph --v3rs10n`

all : build-libs dynagraph gengraph example

build-libs:
	(for i in ${SUBDIRS}; do (cd $$i; $(MAKE)); done)       

dynagraph-whole : main.o $(OBJS) common/libdynagraph.a dynadag/libdynadag.a incrface/libincrface.a pathplot/libpathplot.a fdp/libfdp.a voronoi/libvoronoi.a shortspline/libshortspline.a
	$(CPPSLD) $(LDFLAGS) main.o $(OBJS) $(DGLIBS) $(GVIZLIBS) $(THREADLIBS) -o dynagraph-whole

dynagraph: dynagraph-whole
	strip dynagraph-whole -o dynagraph

release: dynagraph
	bzip2 -kc dynagraph > dynagraph-$(ARCH)-$(GET_VERSION).bz2

#*.o: *.h common/*.h incrface/*.h fdp/*.h dynadag/*.h voronoi/*.h shortspline/*.h pathplot/*.h

gengraph : gengraph.o common/libdynagraph.a
	$(CPPSLD) $(LDFLAGS) gengraph.o $(GGLIBS) $(THREADLIBS) -o gengraph
	
example : cpp_interface_example.o $(OBJS)
	$(CPPSLD) $(LDFLAGS) cpp_interface_example.o $(OBJS) $(DGLIBS) $(GVIZLIBS) $(THREADLIBS) -o example

install: dynagraph gengraph
	(for i in ${SUBDIRS}; do (cd $$i; $(MAKE) install); done)       
	$(MKPATH) $(BINDIR)
	$(INSTALL) dynagraph $(BINDIR)

test: 
	(cd tests; $(MAKE) run)

distclean clean:
	(for i in ${SUBDIRS}; do (cd $$i; $(MAKE) $@); done)     
	(cd tests; $(MAKE) clean)  
	$(RM) *.o core dynagraph dynagraph-whole gengraph

-include $(OBJS:%.o=$(DEPDIR)/%.P)
